<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.1.5/dist/jszip.min.js"></script>
  </head>
  <body>
    <input type="text" name="nameField" id="name">
    <button id="download-button">Download</button>
    <ul>Existing syntax:
      <li>{{name}}</li>
      <li>{{date}}</li>
      <li>{{file}}</li>
    </ul>
    <script src="./app.js"></script>
    <script>
    const downloadButton = document.getElementById('download-button');

    downloadButton.addEventListener('click', () => {
      const pluginMessage = JSON.stringify({
        type: 'collect-data',
        name: document.getElementById('name').value
      })
      parent.postMessage({
        pluginMessage
      }, '*');
    });

    function byteDataToBlob(byteData) {
      return new Blob([new Uint8Array(byteData)], { type: 'image/png' });
    }

    // MULTIPLE FILE EXPORT AS ZIP
    const downloadZip = async (files) => {
      // console.log('FILES --->', files)

      const zip = new JSZip();

      files.forEach(file => {
        zip.file(`${file.name}.png`, byteDataToBlob(file.binaryData[0]), {base64: true});
      });

      zip.generateAsync({ type: 'blob' })
      .then((content) => {
        const zipName = 'assets';

        const blobURL = window.URL.createObjectURL(content);
        const link = document.createElement('a');
        link.className = 'button button--primary';
        link.href = blobURL;
        link.download = `${zipName}.zip`
        link.click()
        link.setAttribute('download', `${zipName}.zip`);

        window.URL.revokeObjectURL(blobURL);
        link.remove();
        console.log('end');
      });

    };

    // SINGLE FILE EXPORT
    const downloadSingleFile = (file) => {
      const blob = new Blob(file.binaryData, {type: 'image/png'});

      // make and click a temporary link to download the Blob
      const blobURL = window.URL.createObjectURL(blob);
      const linkEl = document.createElement('a');
      linkEl.href = blobURL;
      linkEl.download = `${file.name}.png`;
      linkEl.click();
      linkEl.setAttribute('download', `${file.name}.png`);
      window.URL.revokeObjectURL(blobURL);
      linkEl.remove();
    }

    window.onmessage = (msg) => {
      const m = msg.data.pluginMessage;
      if(m.type === 'export-bundle') {
        const exportBundle = m.exportBundle;
        exportBundle.length > 1 ? downloadZip(exportBundle) : downloadSingleFile(exportBundle[0]);
      } else if(m.type === 'send-zip') {
        console.log(m)
      }
      // } else if (m.type = 'test-img') {
      //   // ---- TEST ----

      //   console.log(m.testImg)
      //   const imgEl = document.createElement('img');
      //   const base64Data = btoa(String.fromCharCode.apply(null, m.testImg[0]));
      //   imgEl.src = `data:image/png;base64,${base64Data}`

      //   document.body.appendChild(imgEl);

      //   // ---- TEST END ----
      // }
    }
    </script>
  </body>
</html>