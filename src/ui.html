<input type="text" name="nameField" id="name">
<button id="download-button">Download</button>
<ul>Existing syntax:
  <li>{{name}}</li>
  <li>{{date}}</li>
  <li>{{file}}</li>
</ul>
<!-- <button id="btn1">say hello</button>
<button id="btn2">say bye</button> -->
<!-- <script type="text/javascript" src="../node_modules/@zip.js/zip.js/dist/zip.min.js"></script> -->
<!-- <script type="module" src="../dist/jszip.js"></script> -->
<script>
const downloadButton = document.getElementById('download-button');

// ====== EXAMPLE COMMUNICATION
// const btn1 = document.getElementById('btn1');
// const btn2 = document.getElementById('btn2');

// btn1.addEventListener('click', () => {
//   parent.postMessage({ pluginMessage: {type: 'say-hello', txt:'hello from UI'} }, '*');
// });
// btn2.addEventListener('click', () => {
//   parent.postMessage({ pluginMessage: {type: 'say-bye', txt:'bye from UI'} }, '*');
// });

// window.onmessage = msg => {
//   const m = msg.data.pluginMessage
//   if(m.type === 'say-hello') {
//     console.log(m.txt);
//   }
//   if(m.type === 'say-bye') {
//     console.log(m.txt);
//   }
// };
// ==================

downloadButton.addEventListener('click', () => {
  parent.postMessage({
    pluginMessage: {
      type: 'collect-data',
      name: document.getElementById('name').value
    }
  }, '*');
});

// MULTIPLE FILE EXPORT AS ZIP
const downloadZip = async (exportBundle) => {
  let zipWriter;

  for(let img of exportBundle) {
    var fileName = img.name;
    const blob = new Blob(img.binaryData, {type: 'image/png'});
    zipWriter.add(fileName, blob);
  }

  // make and click a temporary link to download the Blob
  const blobURL = window.URL.createObjectURL(await zipWriter.close());
  const linkEl = document.createElement('a');
  linkEl.href = blobURL;
  // linkEl.download = `${name}.png`;
  linkEl.download = 'assets.zip';
  linkEl.click();
  // linkEl.setAttribute('download', `${name}.png`);
  linkEl.setAttribute('download', 'assets.zip');
  window.URL.revokeObjectURL(blobURL);
  linkEl.remove();
};

// SINGLE FILE EXPORT
const downloadSingleFile = (file) => {
  const blob = new Blob(file.binaryData, {type: 'image/png'});
  // make and click a temporary link to download the Blob
  const blobURL = window.URL.createObjectURL(blob);
  const linkEl = document.createElement('a');
  linkEl.href = blobURL;
  linkEl.download = `${file.name}.png`;
  linkEl.click();
  linkEl.setAttribute('download', `${file.name}.png`);
  window.URL.revokeObjectURL(blobURL);
  linkEl.remove();
}

window.onmessage = (msg) => {
  const m = msg.data.pluginMessage;
  if(m.type === 'export-bundle') {
    const exportBundle = m.exportBundle;
    exportBundle.length > 1 ? downloadZip(exportBundle) : downloadSingleFile(exportBundle[0]);
  }
}

</script>
